{% load staticfiles %}
<div class="row">
	<div class="btn-group btn-group-sm pull-right">
		<button type="submit" class="btn btn-primary" id="makeGroup"><span class="glyphicon glyphicon-plus xwcms" aria-hidden="true"></span> 加用例集</button>
		<button type="submit" class="btn btn-warning" id="exCases"><span class="glyphicon glyphicon-flag xwcms" aria-hidden="true"></span> 置为过期</button>
		<button type="submit" class="btn btn-danger" id="delCases"><span class="glyphicon glyphicon-remove xwcms" aria-hidden="true"></span> 批量删除</button>
	</div>
</div>
<div class="row">
	<span class="label label-primary">共计 {{ show_list|length }} 条</span>

	<table id="tableList" data-toggle="table" data-striped="true" data-show-columns="true" data-row-style="rowStyle" style="word-break:break-all;"  data-click-to-select="true" data-query-params="queryParams" data-search="true" data-show-export="true" data-response-handler="responseHandler">
		<thead>
			<tr>
				<th data-field="state" data-checkbox="true"></th>
				<th data-field="ID" class="col-xs-1"> ID</th>
				<th data-field="用例名称" data-sortable="true" class="col-xs-2">
					用例名称
				</th>
				<th data-field="品类" data-sortable="true" class="col-xs-1">
					品类
				</th>
				<th data-field="版本" data-sortable="true" class="col-xs-1">
					版本
				</th>
				<th data-field="平台" data-sortable="true" class="col-xs-1">
					平台
				</th>
				<th data-field="所属" data-sortable="true" class="col-xs-1">
					所属
				</th>
				<th data-field="备注" data-sortable="true" class="col-xs-1">
					备注
				</th>
				<th data-field="状态" data-sortable="true" class="col-xs-1">
					状态
				</th>
				<th data-field="用例集" data-sortable="true" class="col-xs-2">
					用例集
				</th>
				<th data-field="修改时间" data-sortable="true" class="col-xs-2">
					修改时间
				</th>
				<th data-field="操作" data-sortable="true" class="col-xs-2">
					操作
				</th>
			</tr>
		</thead>
		<tbody id="list">
		{% for x in show_list %}
		<tr>
			<td></td>
			<td>{{ x.id }}</td>
			<td><div name="caseName">{{ x.caseName }}</div></td>
			<td>{{ x.type_field.type_name }}</td>
			<td>{{ x.version }}</td>
			<td>{{ x.plantform }}</td>
			<td>{{ x.owner }}</td>
			<td>{{ x.des }}</td>
			<td>{% if x.in_use == '1' %}<span class='label label-success'>在用</span>{% elif x.in_use == '2'%}<span class='label label-warning'>过期</span>{% else %}<span class='label label-danger'>废弃</span>{% endif %}</td>
			<td>{% if x.caseGroup %}{% for y in x.caseGroup %}<span class="label label-primary">{{y}}</span>{%endfor%}{% else %}<span class="label label-danger">无</span>{% endif %} </td>
			<td>{{ x.modify_time|date:"Y-m-d H:i:s" }}</td>
			<td><a type='button' class="btn btn-sm btn-default" href="/auto/caseConfirm/{{ x.id }}/" target="_blank"><span class="glyphicon glyphicon-pencil xwcms" aria-hidden="true"></span> 编辑</a>
				<button type="submit" class="btn btn-default btn-sm" data-index="{{ x.id }}" data-toggle="modal" data-target="#copyModal"><span class="glyphicon glyphicon-camera xwcms" aria-hidden="true"></span> 复制</button>
			</td>
		</tr>
		{% endfor %}
		</tbody>
	</table>
</div>
{% include "baseTable.html" %}
<script>
	// 构建
	$(".getCases").click(function(){
		var valArr = new Array;
			plantArr = new Array;
			verArr = new Array;
			device = $(this).html().split('#')[0];  // 所选设备
			plat = $(this).attr('name');    // 所选设备平台
			ver = $(this).html().split('#')[1];    // 所选设备版本

		$('input[name="btSelectItem"]:checked').each(function(i){
			valArr[i] = $(this).parent().next().text(); // 所选用例的id
			plantArr[i] = $(this).parent().next().next().next().next().next().text();   // 所选用例的平台
			verArr[i] = $(this).parent().next().next().next().next().text();   // 所选用例的版本
		});

		var vals = valArr.join(',');    //转换为逗号隔开的字符串

		$('#delconfirm').fadeIn(1000);
		// 遍历检查所选是否合规
		for(var i=0;i<plantArr.length;i++){
			if(plantArr[i]!=plat){
				var pass = 'noplat';
				break;
			}else if(verArr[i]!=ver){
				var pass = 'nover';
				break;
			}else{
				var pass = 'pass';
			}
		}

		if(vals){
			if(pass=='pass'){
				$.getJSON("/auto/auto_config",
					{'vals':vals,'device':device},
					function(data){
						$('#titleee').text('构建确认');
						$('#del_mess').html(data.message)
						$('#del_butt').fadeOut(0);
				})
			}else if(pass=='nover'){
				$('#titleee').text('构建确认');
				$("#del_mess").text('错误！所选用例版本 与 所选设备版本不一致！');
				$('#del_butt').fadeOut(0);
			}else{
				$('#titleee').text('构建确认');
				$("#del_mess").text('错误！所选用例平台 与 所选设备平台不一致！');
				$('#del_butt').fadeOut(0);
			}
		}else{
			// 提示并隐藏button
			$('#titleee').text('构建确认');
			$("#del_mess").text('错误！请先选择用例！');
			$('#del_butt').fadeOut(0);
		}
	});
	// 添加用例集
	$("#makeGroup").click(function(){
		var valArr = new Array;
		$('input[name="btSelectItem"]:checked').each(function(i){
			valArr[i] = $(this).parent().next().text();
		});
		var vals = valArr.join(','); // 转换为逗号隔开的字符串
		if(vals){
			$('#make_mess').text('');
			$('#makeconfirm').fadeIn(0);
			$('.editable-select-m').editableSelect({ filter: true });
			$('#make_butt').fadeIn(500);
			$("#makeSure").click(function(){
				var groupName = $('#gourpName').val()
					groupVersion = $('#groupVersion').val()

				if(groupName == '' || groupVersion == ''){
					alert('用例集名称和版本不能为空')
				}else{
					$.get("/auto/autoMakeGroup",{'id':vals,'groupName':groupName,'groupVersion':groupVersion}, function(data,status){
						if (status == 'success' && data == 'success') {
							$("#make_mess").text('成功');
							$("#Search").click()
						//提交失败的操作
						} else {
							$("#make_mess").text('失败，请联系管理员');
						};
					});
					console.log(vals, groupName)
				}
			});
		}else{
			$("#make_mess").text('请先选择用例');
			$('#makeconfirm').fadeIn(0);
			$('#makeconfirm').fadeOut(2000);
		}
	});
	// 取消添加
	$("#makecancle").click(function(){
		$('#makeconfirm').fadeOut(500)
	});
</script>
